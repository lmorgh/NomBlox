LongJohnson:
  type: assignment
  actions:
    on assignment:
    - trigger name:chat state:true radius:4
  interact scripts:
  - 10 LongJohnson_interact
  
LongJohnson_interact:
  type: interact
  steps:
    1:
      click trigger:
        script:
        - if <player.has_flag[npc_engaged]> queue clear
        - flag player npc_engaged
        
        - if !<player.has_flag[LongJohnson_rum_bought]>
        {
          - narrate "<dark_aqua>An old man is standing at the counter. He looks somewhat angry and unhappy. Drunk, too."
          - wait 5
          - random
          {
            - narrate format:npcf "What yer lookin at, eh? Leave me alone with my rum. It's the only thing I enjoy anymore."
            - narrate format:npcf "Stop staring. Haven't you seen a man getting drunk from rum before?"
            - narrate format:npcf "Rum. Yum. Yum."
          }
          - wait 5
          - narrate "<dark_aqua>You feel intrigued by the man, but you don’t want any trouble. If only there was a way to get on his good side."
          - flag player LongJohnson_met
          #za ta flag preveri potem barkeep. Èe ga maš, ti v chatu ponudi opcijo kupit rum za Longa. Èe kupiš, dobiš flag [LongJohnson_rum_bought]
        }
        else
        {
          - narrate format:youf "I ordered some more rum for you, my treat."
          - wait 4
          - narrate format:npcf "That's a swell thing to do, matey. I think I owe you an introduction. People call me Captain <npc.name>."
          - wait 6
          - narrate format:youf "A pleasure to meet you, captain. Say, you seem a bit down. Is everything alright?"
          - wait 5
          - narrate format:npcf "Alright? All … Right? Oh my dog, didn’t you see that wreck of a ship over there??"
          - wait 5
          - narrate "<dark_aqua>He makes a drunken gesture with his hand towards the shipyard."
          - wait 4
          - narrate format:npcf "Hope Floats, that was her name. She used to be the greatest ship that has ever sailed the seas. But now... it's just Floats, no hope."
          - wait 7
          - narrate "<dark_aqua>You’re not sure whether the man is serious or it’s the booze talking."
          - wait 4
          - narrate format:npcf "Me great-great-grandfather had her built in his time. She was his treasure, then she was his son's treasure, and so on all the way to me. Now she's my shame."
          - wait 9
          - narrate "<dark_aqua>As he said that, he lowered his head and let out a long, bitter sigh."
          - wait 4
          - narrate format:npcf "I was supposed to be a great capt'n, you know, like me father, and his father before him. I was supposed to live up to my honorable family name. But now... I'm a wreck, just like me ship."
          - wait 10
          - narrate format:youf "It sounds like you had some large shoes to fill. I'm sure it was tough having to live up to your father's expectations."
          - wait 7
          - narrate format:npcf "Aye, 'twas horrible. But that's in he past. All I have to worry about now is keeping my throat wet. Will you buy me another bottle?"
          - wait 7
          - run RumChoice
          - zap 2
        } 
        - flag player npc_engaged:!
        
    2:
      click trigger:
        script:
        - if <player.has_flag[npc_engaged]> queue clear
        - flag player npc_engaged
        - if <player.has_flag[LongJohnson_passout]> 
        {
          - narrate "<dark_aqua>You tap his shoulder a few times, but he's sound asleep. He looks like he won't regain consciousness for at least <red><player.flag[LongJohnson_passout].expiration.formatted><dark_aqua>."
          - flag player npc_engaged:!
          - queue clear
        }
        - run RumChoice
        - flag player npc_engaged:!
        
      chat trigger:
        1:
          trigger: /regex:(?i)1|one|buy|drink|rum|another\+REPLACE:<yellow>Let me buy you another drink./
          script:
          - if <player.has_flag[npc_engaged]> queue clear
          - if <player.has_flag[LongJohnson_passout]>
          {
            - narrate "<dark_aqua>No answer, he's still out."
            - flag player npc_engaged:!
            - queue clear
          }
          - flag player npc_engaged
          
          - wait 3 
          - narrate "<dark_aqua>You order a new bottle from the barkeep."
          - wait 3
          - narrate format:npcf "Bless yer heart, matey. All the live long day!"
          - wait 3 
          - narrate "<dark_aqua><npc.name> tilted his head back and poured the rum straight down his throat."
          - wait 3
          - narrate format:npcf "Ahhh! That's *hic* better. Yer a *hic* jolly good fellow, ya *hic* know? Why I eyes ya."
          - wait 3 
          - narrate "<dark_aqua>The words from his mouth are becoming less and less clear, until he can't hold his head up anymore and passes out."
          - flag player LongJohnson_passout duration:61m
          - wait 6
          - narrate format:youf "Captain? Sir?"
          - wait 2
          - narrate "<dark_aqua>You tap his shoulder a few times, but he's sound asleep. He looks like he won't regain consciousness for at least <red><player.flag[LongJohnson_passout].expiration.formatted><dark_aqua>."
          - flag player npc_engaged:!
          
        2:
          trigger: /regex:(?i)2|two|no\+REPLACE:<yellow>I think that's quite enough rum for you./
          script:
          - if <player.has_flag[npc_engaged]> queue clear
          - if <player.has_flag[LongJohnson_passout]>
          {
            - narrate "<dark_aqua>No answer, he's still out."
            - flag player npc_engaged:!
            - queue clear
          }
          - flag player npc_engaged
          
          - wait 3 
          - narrate format:npcf "Whaddya mean, enough rum?"
          - wait 2
          - narrate format:youf "I mean you should take a hold of yourself. Rum is not the answer, it's only making you miserable."
          - wait 5 
          - narrate "<dark_aqua>At first Captain looked like he is about to throw a punch at you in his drunken stupor, but suddenly the look in his eyes changed completely."
          - wait 6
          - narrate format:npcf "Oh Don Piano, you're right. But it's not rum that's holding me back, it's meself."
          - wait 4
          - narrate "<dark_aqua>The realisation seemed to have sobered him up quickly."
          - wait 4
          - narrate format:npcf "I have to tend to me ship, have it fixed, and set sail once again. You've helped me get back on me feet, for that I thank ye."
          - wait 4
          - narrate "<dark_aqua>It seems that Captain is back to his old self, as he disappears through the door towards the shipyard."
          - adjust <player> show_entity:<npc[15]>
          - flag player LongJohnson_sober
          - adjust <player> hide_entity:<npc[14]>
          - zap 3
          
          
          - flag player npc_engaged:!
          
        unknown: 
          trigger: /regex:.+/ 
          script: 
          - random
          {
            - narrate format:npcf "What are you blabbering about?"
            - narrate format:npcf "Speak up, matey. What was that?"
            - narrate format:npcf "I don't understand what you mean."       
            - narrate format:npcf "I don't know what you're saying." 
          }

RumChoice:
  type: task
  script:
  - narrate "<dark_aqua>This man has surely seen better days. You feel like you should help him out."
  - wait 1
  - narrate "<&nl>"
  - narrate "<gray>Take an action (type the number to suggest that line)"
  - ^narrate "1 - <gold>Buy him another bottle"
  - ^narrate "2 - <gold>Don't buy him another bottle"
  
  
#################################################################################################
#                                                                                               #
#                                      AFTER SOBERING UP                                        #
#                                                                                               #
#################################################################################################  
LongJohnson2:
  type: assignment
  actions:
    on assignment:
    - trigger name:chat state:true radius:4
  interact scripts:
  - 10 LongJohnson2_interact


LongJohnson2_interact:
  type: interact
  steps:
    1:
      click trigger:
        script:
        - if <player.has_flag[npc_engaged]> queue clear
        - flag player npc_engaged
        
        - narrate format:npcf "I'll give you some quests, as soon as lmorgh writes them for me!"
        - flag player npc_engaged:!
        
        
DoppelgangerHider:
  type: world
  events:
    on player joins:
    - if !<player.has_flag[LongJohnson_sober]>
    {
      - adjust <player> hide_entity:<npc[15]>
    }
    else
    {
      - adjust <player> hide_entity:<npc[14]>
    }
    
    
  